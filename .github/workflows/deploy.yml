name: GCP

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Setup Gcloud Account
    runs-on: ubuntu-latest
    environment: prod
    env:
      IMAGE_NAME: gcr.io/${{ secrets.GCP_PROJECT_ID }}/site:latest
    steps:
      # Git checkout
      - name: Checkout
        uses: actions/checkout@v3
      # set database url
      - name: Set database url
        run: export DB_URL=${{ secrets.DB_URL }}
      # set database user
      - name: Set database user
        run: export DB_USER=${{ secrets.DB_USER }}
      # set database password
      - name: Set database password
        run: export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
      # Authenticate
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # Specify project
      - uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # gcloud configure docker
      - name: Configure Docker
        run: gcloud auth configure-docker --quiet

      # build image
      - name: Build Docker image
        run: docker build -t $IMAGE_NAME .

      # push image to registry
      - name: Push Docker image
        run: docker push $IMAGE_NAME

      # deploy image
      - name: Deploy Docker image
        run: gcloud run deploy site --image $IMAGE_NAME --region=us-east1 --memory 1Gi --min-instances 1 --max-instances 1 --platform managed --port 80 --allow-unauthenticated
